<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Landmark Annotation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background: #f0f0f0;
    }
    #container {
      display: inline-block;
      position: relative;
      border: 1px solid #ccc;
      background: #fff;
    }
    canvas {
      display: block;
    }
    #controls {
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      margin: 0 10px;
      font-size: 16px;
      cursor: pointer;
    }
    #counterText {
      font-size: 18px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h2>Image Landmark Annotation Tool</h2>
  <div id="container">
    <canvas id="imageCanvas"></canvas>
  </div>
  <div id="controls">
    <button id="skipButton">Skip Image</button>
    <button id="saveButton">Save XML</button>
    <span id="counterText"></span>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const canvas = document.getElementById("imageCanvas");
      const ctx = canvas.getContext("2d");
      const skipButton = document.getElementById("skipButton");
      const saveButton = document.getElementById("saveButton");
      const counterTextSpan = document.getElementById("counterText");

      // --- Configuration ---
      // List of image paths â€“ update these paths as needed.
      const images = [
        "images/image1.jpg",
        "images/image2.jpg",
        "images/image3.jpg"
      ];
      const maxLandmarks = 5;  // Maximum landmarks required per image

      // --- Global state ---
      let currentImageIndex = 0;
      let currentImage = new Image();
      let landmarksData = {};    // e.g. { "images/image1.jpg": [{x: 10, y: 20}, ...] }
      let imageDimensions = {};  // e.g. { "images/image1.jpg": { width: 800, height: 600 } }
      let waitingForNextClick = false;  // when true, next left-click loads next image

      // --- Load and display an image ---
      function loadImage() {
        if (currentImageIndex >= images.length) {
          alert("All images processed. You can now save the landmarks.");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          return;
        }
        const imagePath = images[currentImageIndex];
        currentImage.src = imagePath;
        currentImage.onload = function() {
          canvas.width = currentImage.naturalWidth;
          canvas.height = currentImage.naturalHeight;
          imageDimensions[imagePath] = { width: currentImage.naturalWidth, height: currentImage.naturalHeight };

          // Initialize landmarks array if not present
          if (!landmarksData[imagePath]) {
             landmarksData[imagePath] = [];
          }
          waitingForNextClick = false;
          drawImage();
          updateCounter();
        }
      }

      // --- Draw the image, landmarks, and counter text on the canvas ---
      function drawImage() {
        // Clear and draw the current image
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);

        // Draw counter text (e.g., "Image 1/3")
        let counter = `Image ${currentImageIndex + 1} / ${images.length}`;
        ctx.font = "20px Arial";
        ctx.fillStyle = "blue";
        ctx.fillText(counter, 10, 30);

        // Draw landmarks (circles)
        const points = landmarksData[images[currentImageIndex]];
        if (points) {
          points.forEach(point => {
            ctx.beginPath();
            ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
            ctx.fillStyle = "red";
            ctx.fill();
            ctx.strokeStyle = "blue";
            ctx.stroke();
          });
        }
      }

      // --- Update on-screen counter ---
      function updateCounter() {
        counterTextSpan.textContent = `Image ${currentImageIndex + 1} of ${images.length}`;
      }

      // --- Canvas click events ---
      canvas.addEventListener("click", function(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const imagePath = images[currentImageIndex];
        const points = landmarksData[imagePath];

        // If already reached max landmarks, a left-click loads next image
        if (waitingForNextClick) {
          loadNextImage();
          return;
        }

        // Left-click: add a landmark if limit not reached
        if (points.length < maxLandmarks) {
          points.push({ x, y });
          drawImage();
          if (points.length === maxLandmarks) {
             waitingForNextClick = true;
             // Optionally, you might provide a visual cue that the image is complete.
          }
        }
      });

      // --- Right-click: remove the last landmark ---
      canvas.addEventListener("contextmenu", function(e) {
        e.preventDefault(); // Prevent the default context menu from appearing
        const imagePath = images[currentImageIndex];
        const points = landmarksData[imagePath];
        if (points.length > 0) {
          points.pop();
          waitingForNextClick = false;
          drawImage();
        }
        return false;
      });

      // --- Keyboard shortcut: Tab key to skip the image ---
      document.addEventListener("keydown", function(e) {
        if (e.key === "Tab") {
          e.preventDefault();
          skipImage();
        }
      });

      // --- Skip button handler ---
      skipButton.addEventListener("click", function() {
        skipImage();
      });

      // --- Save button handler: Generate and download XML ---
      saveButton.addEventListener("click", function() {
        saveXML();
      });

      // --- Skip the current image (delete landmarks and load next) ---
      function skipImage() {
        const imagePath = images[currentImageIndex];
        delete landmarksData[imagePath];
        loadNextImage();
      }

      // --- Load the next image ---
      function loadNextImage() {
        currentImageIndex++;
        if (currentImageIndex < images.length) {
          loadImage();
        } else {
          alert("All images processed. You can now save the landmarks.");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      // --- Save landmarks data as XML ---
      function saveXML() {
        // Create an XML document
        let xmlDoc = document.implementation.createDocument("", "", null);
        let datasetElem = xmlDoc.createElement("dataset");

        let nameElem = xmlDoc.createElement("name");
        nameElem.textContent = "Image Dataset";
        datasetElem.appendChild(nameElem);

        let commentElem = xmlDoc.createElement("comment");
        commentElem.textContent = "This dataset contains images with landmarks.";
        datasetElem.appendChild(commentElem);

        let imagesElem = xmlDoc.createElement("images");

        // Iterate over all images
        images.forEach(imagePath => {
          if (!landmarksData[imagePath]) return;
          const points = landmarksData[imagePath];
          let imageElem = xmlDoc.createElement("image");
          imageElem.setAttribute("file", imagePath);

          const dims = imageDimensions[imagePath] || { width: 0, height: 0 };
          let boxElem = xmlDoc.createElement("box");
          boxElem.setAttribute("top", "1");
          boxElem.setAttribute("left", "1");
          boxElem.setAttribute("width", (dims.width - 1).toString());
          boxElem.setAttribute("height", (dims.height - 1).toString());

          // Add each landmark as a part element
          points.forEach((pt, idx) => {
            let partElem = xmlDoc.createElement("part");
            partElem.setAttribute("name", idx.toString());
            partElem.setAttribute("x", pt.x.toString());
            partElem.setAttribute("y", pt.y.toString());
            boxElem.appendChild(partElem);
          });
          imageElem.appendChild(boxElem);
          imagesElem.appendChild(imageElem);
        });
        datasetElem.appendChild(imagesElem);
        xmlDoc.appendChild(datasetElem);

        // Serialize the XML to a string and trigger a download
        let serializer = new XMLSerializer();
        let xmlString = serializer.serializeToString(xmlDoc);
        let blob = new Blob([xmlString], { type: "text/xml" });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url;
        a.download = "landmarks.xml";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // --- Start by loading the first image ---
      loadImage();
    });
  </script>
</body>
</html>
